const saveFlat = require('./saveFlat')
const cheerio = require('cheerio')
const puppeteer = require('puppeteer')

const siteUrl = 'https://www.bezrealitky.cz/vyhledat#offerType=prodej&estateType=byt&disposition=&ownership=&construction=&equipped=&balcony=&order=timeOrder_desc&boundary=%7B%22type%22%3A%22Feature%22%2C%22properties%22%3A%7B%7D%2C%22geometry%22%3A%7B%22type%22%3A%22Polygon%22%2C%22coordinates%22%3A%5B%5B%5B14.2244355%2C50.1029963%5D%2C%5B14.2498381%2C50.1034693%5D%2C%5B14.2609996%2C50.0962906%5D%2C%5B14.2610944%2C50.0870952%5D%2C%5B14.273347%2C50.087619%5D%2C%5B14.2752539%2C50.0810719%5D%2C%5B14.2893735%2C50.0771366%5D%2C%5B14.2901916%2C50.073178%5D%2C%5B14.2785556%2C50.0709193%5D%2C%5B14.2580521%2C50.0715166%5D%2C%5B14.2587145%2C50.0644236%5D%2C%5B14.2475584%2C50.0622236%5D%2C%5B14.2480852%2C50.0583091%5D%2C%5B14.2643067%2C50.0523325%5D%2C%5B14.2716323%2C50.0543186%5D%2C%5B14.2700997%2C50.040097%5D%2C%5B14.2872209%2C50.0279596%5D%2C%5B14.3158709%2C50.0235953%5D%2C%5B14.3114577%2C50.006978%5D%2C%5B14.3007933%2C50.0118141%5D%2C%5B14.30053%2C50.0043801%5D%2C%5B14.2948377%2C50.0022104%5D%2C%5B14.3139615%2C49.9947829%5D%2C%5B14.3181009%2C49.9888928%5D%2C%5B14.3349813%2C49.9938483%5D%2C%5B14.3427557%2C49.9906305%5D%2C%5B14.3353153%2C49.9886648%5D%2C%5B14.3395903%2C49.9807517%5D%2C%5B14.3268139%2C49.9718584%5D%2C%5B14.3461789%2C49.9747107%5D%2C%5B14.344916%2C49.9676279%5D%2C%5B14.3292319%2C49.9648505%5D%2C%5B14.3254392%2C49.9572087%5D%2C%5B14.3428774%2C49.9475842%5D%2C%5B14.3879707%2C49.9497837%5D%2C%5B14.395562%2C49.9419006%5D%2C%5B14.3942296%2C49.9538976%5D%2C%5B14.4006472%2C49.9706693%5D%2C%5B14.4194183%2C49.9635636%5D%2C%5B14.4386195%2C49.9681197%5D%2C%5B14.4445941%2C49.9738632%5D%2C%5B14.4622402%2C49.9707711%5D%2C%5B14.4663038%2C49.9810366%5D%2C%5B14.486985%2C49.985687%5D%2C%5B14.4839334%2C49.992419%5D%2C%5B14.5072536%2C49.9974771%5D%2C%5B14.5081846%2C49.9921388%5D%2C%5B14.5137466%2C49.992583%5D%2C%5B14.5300192%2C50.0007153%5D%2C%5B14.520994%2C50.0077216%5D%2C%5B14.5274725%2C50.0108381%5D%2C%5B14.5508521%2C50.0079867%5D%2C%5B14.5542318%2C50.0121564%5D%2C%5B14.5627521%2C50.0115863%5D%2C%5B14.5683172%2C50.0073516%5D%2C%5B14.582393%2C50.0163634%5D%2C%5B14.5817136%2C50.010951%5D%2C%5B14.6022636%2C50.0094315%5D%2C%5B14.6039007%2C50.0019258%5D%2C%5B14.6103406%2C49.9986363%5D%2C%5B14.6401518%2C49.9944411%5D%2C%5B14.6469229%2C49.9987546%5D%2C%5B14.6382891%2C50.0057827%5D%2C%5B14.6498044%2C50.0087938%5D%2C%5B14.6577854%2C50.0043495%5D%2C%5B14.669537%2C50.0188407%5D%2C%5B14.6561272%2C50.0309551%5D%2C%5B14.6569571%2C50.0378173%5D%2C%5B14.6668511%2C50.0385277%5D%2C%5B14.6538674%2C50.0492542%5D%2C%5B14.6440386%2C50.0421831%5D%2C%5B14.6401916%2C50.0568947%5D%2C%5B14.6999919%2C50.0721289%5D%2C%5B14.7067867%2C50.0870194%5D%2C%5B14.6886937%2C50.0963003%5D%2C%5B14.6903288%2C50.1006277%5D%2C%5B14.6574355%2C50.1065009%5D%2C%5B14.6591154%2C50.1226041%5D%2C%5B14.6352008%2C50.1239183%5D%2C%5B14.6322995%2C50.1299032%5D%2C%5B14.6005164%2C50.129523%5D%2C%5B14.5877286%2C50.1452435%5D%2C%5B14.5990028%2C50.1541328%5D%2C%5B14.5632297%2C50.1501702%5D%2C%5B14.5609936%2C50.1615751%5D%2C%5B14.5505391%2C50.1661221%5D%2C%5B14.5342354%2C50.161565%5D%2C%5B14.5305116%2C50.1661902%5D%2C%5B14.5324832%2C50.1771831%5D%2C%5B14.5268551%2C50.1774301%5D%2C%5B14.5069039%2C50.1714361%5D%2C%5B14.4669127%2C50.1695438%5D%2C%5B14.4641231%2C50.159923%5D%2C%5B14.4281375%2C50.1576674%5D%2C%5B14.4289771%2C50.1535113%5D%2C%5B14.4200136%2C50.1529649%5D%2C%5B14.4225022%2C50.1498332%5D%2C%5B14.3999734%2C50.1479062%5D%2C%5B14.3949016%2C50.141429%5D%2C%5B14.3848779%2C50.1469262%5D%2C%5B14.3657001%2C50.1480311%5D%2C%5B14.3541236%2C50.137526%5D%2C%5B14.3600421%2C50.1295213%5D%2C%5B14.3556407%2C50.1246523%5D%2C%5B14.3607835%2C50.1160189%5D%2C%5B14.3206068%2C50.1152415%5D%2C%5B14.3158782%2C50.1286167%5D%2C%5B14.3024335%2C50.1300768%5D%2C%5B14.2946854%2C50.1247846%5D%2C%5B14.2971713%2C50.1205942%5D%2C%5B14.2883495%2C50.1162211%5D%2C%5B14.2788382%2C50.1190811%5D%2C%5B14.2500356%2C50.1107913%5D%2C%5B14.2388054%2C50.1117993%5D%2C%5B14.2393227%2C50.1072816%5D%2C%5B14.2244355%2C50.1029963%5D%5D%5D%7D%7D&center=%5B14.465611099999933%2C50.05980988882612%5D&zoom=8.719850910007633&locationInput=Praha%2C%20%C4%8Cesko&limit=15'

const fetchBezRealitky = async () => {
  console.log('Scraping BezRealitky..')

  const browser = await puppeteer.launch({
    args: [
      '--no-sandbox',
      '--headless',
      '--disable-gpu',
      '--window-size=1920x1080'
    ]
  })
  const page = await browser.newPage()
  page.setDefaultNavigationTimeout(0)

  const getLinks = async () => {
    await page.goto(siteUrl, {
      waitUntil: 'networkidle2'
    })

    try {
      await page.screenshot({ path: './server/scraper/testBefore.png', fullPage: true })
      for (let i = 0; i < 1; i++) {
        await page.evaluate(() => {
          try {
            const nextButton = document.querySelectorAll('button.btn.btn-secondary.btn-icon')[0]
            nextButton.click()
          } catch {
            console.error('error')
          }
        })
        console.log(`click no. ${i}`)
        await page.waitFor(5000)
      }
      const links = []
      const content = await page.content()
      const $ = await cheerio.load(content)
      $('.product__link').each((i, el) => {
        links.push(el.attribs.href)
      })

      console.log(`fetched ${links.length} links`)
      return links
    } catch (err) {
      console.log(err)
    }
  }

  for (const flatUrl of await getLinks()) {
    try {
      const flat = {
        link: flatUrl,
        city: 'Praha',
        agency: 'BezRealitky'
      }

      await page.goto(flatUrl)
      const content = await page.content()
      const $ = await cheerio.load(content)

      const location = $('.heading__perex').text()
      const locationTrim = location.trim()
      const area = locationTrim.split('-')[1]
      const neighbourhood = area.trim().split(' ')
      console.log(neighbourhood)
      // flat.neighbourhood = neighbourhood.trim()
      // console.log(flat.neighbourhood)
      // flat.address = locationTrim.split(',')[0]
      //
      // console.log(flat)
    } catch (err) {
      console.log(err)
    }
  }

  await browser.close()
}

fetchBezRealitky()
